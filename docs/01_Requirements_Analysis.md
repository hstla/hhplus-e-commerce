# 📦 E-Commerce 주문 서비스 설계 문서
## 목차
- [요구사항 분석](01_Requirements_Analysis.md)
- [ERD](03_erd.md)
- [핵심 로직 다이어그램](02_Sequence_Diagram.md)
- [플로우 차트](04_flowchart.md)
- [아키텍처 및 패키지 구조](05_Architecture.md)
- [↩️ README로 돌아가기](../README.md#주요기능-및-아키텍처-링크들)

## 1. 핵심 기능 요구사항
### 1) 포인트 관리
* 포인트 조회
    * 사용자는 자신의 ID를 통해 현재 보유 포인트를 조회할 수 있으며, 잔액이 없는 경우 0으로 응답합니다.
* 포인트 충전
    * 유효성 검증: 충전 금액은 1만 원 이상, 100만 원 이하의 범위 내에서만 유효합니다.
    * 로직: 유효한 요청 시 사용자의 잔액을 즉시 증가시키고, 상세 내역(사용자, 금액, 시간)을 담은 충전 이력을 기록합니다.
    * 응답: 처리 완료 후, 현재 총 잔액을 반환합니다.
    * 비기능적 요구사항: 동일 사용자의 동시 충전 요청이 발생하더라도 데이터 정합성이 보장되어야 합니다 (동시성 제어).

### 2) 상품 조회
* 기능: 사용자는 상품 ID를 통해 상품의 기본 정보(이름, 가격 등)와 실시간 재고를 함께 조회할 수 있습니다.
* 재고 처리: 조회 시점에 재고가 0인 경우, '품절' 상태로 명확하게 표시되어야 합니다.
* 비기능적 요구사항: 재고 데이터는 항상 정확한 상태를 유지해야 합니다 (데이터 정합성).

### 3) 주문 및 결제
* 주문 생성
    * 재고 확인: 주문 요청 시, 시스템은 가장 먼저 상품의 재고를 확인하고 부족할 경우 오류를 반환해야 합니다.
    * 쿠폰 적용: 유효한 쿠폰을 사용할 수 있으며, 할인 금액이 총 주문액보다 클 경우 최종 결제액은 0으로 처리됩니다.
    * 상태 관리: 주문이 성공적으로 접수되면, 주문 정보는 CREATED(생성됨) 상태로 저장됩니다.
* 결제 처리
    * 잔액 확인: 사용자의 잔액이 주문 금액보다 부족할 경우, 결제는 실패 처리됩니다.
    * 로직: 결제가 성공하면 사용자의 잔액을 차감하고, 주문 상태를 PAID(결제 완료)로 변경합니다. 실패 시에는 FAILED(실패)로 변경합니다.
    * 비기능적 요구사항:
        * 동시성 제어: 재고 및 잔액 차감 과정에서 동시성 문제가 발생하지 않도록 제어해야 합니다.

### 4) 선착순 쿠폰 발급
* 기능: 사용자는 선착순으로 제공되는 쿠폰을 발급받을 수 있습니다.
* 제약 조건:
    * 한 사용자당 동일한 쿠폰은 중복 발급이 불가능합니다.
    * 시스템은 발급 요청 시 쿠폰의 재고, 유효기간 등의 조건을 실시간으로 검증해야 합니다.
* 비기능적 요구사항: 
  * 동시성 제어: 다수의 사용자가 동시에 쿠폰 발급을 요청할 때 발생하는 경쟁 상태(Race Condition)를 제어하여, 재고가 음수가 되거나 실제보다 많이 발급되지 않도록 정확하게 차감해야 합니다.
  * 성능 최적화: 중복 발급 여부를 빠르게 확인하기 위해, 발급된 사용자 ID를 Redis Set 자료구조에 저장하여 O(1) 시간 복잡도로 필터링합니다.

### 5) 인기 판매 상품 조회
* 기능: 최근 3일간(어제까지의 데이터 기준) 가장 많이 팔린 상위 5개 상품의 목록을 조회합니다.
* 비기능적 요구사항:
    * 성능 최적화: 매번 주문 테이블 전체를 집계하는 비효율을 피하기 위해, Redis 캐시를 활용합니다.
    * 데이터 갱신: TTL을 하루로 잡아 매일 초기화 시킵니다. 
      첫 요청이 들어오면 레디스에서 지난 3일간 주문 데이터를 조회하여 인기 순위를 갱신합니다. (당일 판매량은 다음 날 집계에 반영)

## 2. 비즈니스 유효성 검증 규칙
각 도메인 모델의 필드에 대한 비즈니스 규칙은 다음과 같습니다.

| 엔티티/필드 | 검증 규칙 |
| :---- | :---- |
| User | name: 2 ~ 20 글자 password: 5 ~ 30 글자 point: 충전 시 10,000 이상 1,000,000 이하 |
| Product | name: 1 ~ 30 글자 description: 10 ~ 200 글자 |
| ProductOption | name: 1 ~ 30 글자 |
| Coupon | name: 5 ~ 20 글자 initial_stock: 0 이상 |