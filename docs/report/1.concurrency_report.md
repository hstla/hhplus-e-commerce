# DB Lock 적용 보고서

### DB Lock 개념

DB Lock 은 동시에 접근하는 여러 트랜잭션 간의 정합성과 일관성을 보장하기 위한 동시성 제어 기법으로, 대표적으로 두 가지 전략이 있다.

- 비관적 락 (Pessimistic Lock)
  - 충돌이 자주 발생할 것이라고 가정하고, 데이터를 읽는 시점부터 락을 걸어 다른 사용자가 해당 데이터에 접근하지 못하게 막는다.
    트랜잭션이 완료될 때까지 락이 유지된다.
- 낙관적 락(Optimistic Lock)
  충돌이 발생할 확률이 낮다고 가정하고, 별도의 DB 락을 걸지 않고 데이터를 읽는다. 데이터 업데이트 시점에서 다른 사용자의 변경사항이 있었는지 확인(version)하고,
  충돌이 발생하면 재시도 또는 실패를 처리한다.

### 문제 식별 및 분석
이번 프로젝트에서 동시성 제어가 필요하다고 생각한 주요 시나리오는 다음 세가지이다.
#### 1. 실시간 쿠폰 발급
특정 시간에 수많은 사용자가 동시에 몰려 쿠폰을 받으려는 이벤트 시나리오를 예상.
ex) 8월 15일 5시 랜덤 쿠폰 발급 이벤트! <br>
**충돌 가능성이 높다.**
#### 2. 결제 시 포인트 차감
쿠폰 발급보다는 충돌 가능성이 낮지만, 결제는 돈이라는 매우 민감한 데이터와 연관되어 있다. 포인트가 정확하게 차감되지 않거나, 이중 차감되는 등의 문제는 치명적인 데이터 무결성 훼손이라고 생각하여, 최대한 안전한 비관적 락을 선택했다.
<br> **충돌 가능성 낮음, 데이터 무결성 중요도 높음**
#### 3. 주문 시 상품 재고 차감
일반적으로 주문 요청이 특정 시간에 몰리는 경우가 드물다고 생각했고, 만약 동시성 제어에 실패하여 상품 재고가 음수가 되는 일이 있어도 주문 취소, 등 후속 처리가 가능하기 때문에 낙관적 락을 선택했다.
<br> **충돌 가능성 낮음**

### 해결 전략
- 실시간 쿠폰 발급 및 결제 시 포인트 차감
  - 충돌 가능성이 높거나 데이터 무결성이 매우 중요한 시나리오이므로  **SELECT ... FOR UPDATE**와 같은 비관적 락을 사용하여 동시 요청을 순차적으로 처리하였고 이를 통해 쿠폰 재고의 정확한 차감과 포인트의 일관성 있는 처리를 보장할 수 있다.
- 주문 시 재고 차감
  - 충돌 가능성이 낮고 실패 시 후속 처리가 가능한 시나리오이므로 낙관적 락을 적용하여 엔티티에 @Version 컬럼을 추가하고, 여러 요청이 동시에 재고를 수정하려 할 때 버전 충돌이 발생하면 미리 정의된 횟수만큼 재시도하는 로직을 구현하였다. 
    이를 통해 대부분의 요청은 락 없이 빠르게 처리되고, 충돌이 발생한 소수의 요청만 재시도를 통해 동시성 제어를 할 수 있었다.

