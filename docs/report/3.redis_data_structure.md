## Redis 자료 구조를 이용한 설계 문서
### 1. 핵심 개선 사항

아래 두가지의 기능을 변경하였습니다. <br>
#### 3일간 인기상품 조회 기능 <br>

하루 한 번, 배치 프로세스가 DB를 집계하여 Redis에 캐시 ->
상품 구매 시 Redis Sorted Set에 실시간으로 판매량을 누적하고, 스케줄러가 3일간의 데이터를 동적으로 집계하여 제공

#### 실시간 쿠폰 발급 기능 <br>

정규화된 테이블에 RDBMS의 **비관적 락(Pessimistic Lock)**을 사용하여 동시성 제어 ->
Redis Sorted Set을 대기열로 활용하고, Redis의 원자적 연산과 비동기 스케줄러를 통해 동시성 제어

### 2. 기술 선택 및 배경
    
캐시를 구현할 수 있는 방법은 아래 두가지가 있습니다.
##### @Cacheable
- 어노테이션 기반
- String (Key-Value)만 가능
- 단순 조회 결과 캐싱에 적합

##### RedisTemplate
- 어노테이션보다 상대적으로 복잡한 코드 기반
- Set, Sorted Set, List, Hash, Bitmap 등 다양한 redis 자료구조 사용 가능
- 복잡한 비즈니스 로직, 동시성 제어, 대기열 구현 등 구현 가능

redis 자료구조에 대해 몰랐을 때는 어노테이션만 사용했지만, redis 자료구조의 장점을 알고 활용하면 RedisTemplate 이 훨씬 유용했습니다.


#### 2.1 직렬화(Serialization) 전략
레디스에 데이터를 저장하고 읽기 위해, Jackson2JsonRedisSerializer를 기반으로 한 커스텀 직렬화기 TRJackson2JsonRedisSerializer를 구현하여 적용했습니다.

선택 사유: Redis를 처음 도입하는 단계에서 Key-Value에 어떤 값이 어떻게 저장되는지 시각적으로 명확하게 확인하고 디버깅하기 위해, 사람이 읽을 수 있는 JSON 포맷을 선택했습니다.


### 3. 최종 시스템 아키텍처

#### 3일간 인기 상품 조회 Top 5
수집 (Collection): 사용자가 상품을 구매할 때마다, Redis Sorted Set에 ZINCRBY sales:daily:yy-MM-dd <productId> <quantity> 명령으로 일별 상품 판매량을 누적 저장합니다.

집계 (Aggregation): 매일 자정에 스케줄러가 실행되어, ZUNIONSTORE 명령으로 최근 3일 치의 판매량 데이터(sales:daily:*)를 합산합니다. 합산된 결과는 sales:rank:3d라는 새로운 Sorted Set 키에 저장되며, 이 키에는 24시간의 TTL(Time-To-Live)을 설정하여 매일 데이터가 갱신되도록 합니다.

조회 (Querying): 사용자가 인기 상품 조회를 요청하면, ZREVRANGE sales:rank:3d 0 4 WITHSCORES 명령을 통해 sales:rank:3d 키에서 판매량 순위가 가장 높은 5개의 상품을 조회하여 응답합니다.

#### 실시간 쿠폰 발급
사전 검증 (Pre-validation): 사용자의 쿠폰 발급 요청 시, API 서버는 Redis를 통해 아래 항목들을 빠르게 검증하여 유효하지 않은 요청을 즉시 차단합니다.

Rate Limit: INCR (String)

유효 쿠폰 여부: SISMEMBER (Set)

중복 발급 여부: GETBIT (Bitmap)

대기열 추가 및 발급 처리 (Queueing & Issuance): 검증을 통과한 요청은 Sorted Set 대기열에 추가하고, 사용자에게는 즉시 202 Accepted를 응답합니다. 별도의 스케줄러가 대기열에서 요청을 순서대로 꺼내 DECR 명령으로 재고(String)를 원자적으로 차감합니다.

결과 저장 (Persistence): 재고 차감에 성공한 요청은 List 자료구조로 구현된 'DB 저장 큐'로 전달됩니다. 최종적으로 다른 스케줄러가 이 큐의 작업을 처리하여 발급 완료 기록(Bitmap)을 남기고, RDBMS에 UserCoupon 정보를 영구 저장합니다.

##### 수정된 설계
데이터베이스 스키마 단순화: 기존에는 비관적 락의 경합 범위를 줄이기 위해 Coupon과 Coupon_Stock 테이블을 분리했습니다. 
하지만 실시간 재고 관리의 주체(sot)를 Redis로 이전하면서 더 이상 DB 락이 필요 없게 되었고, 이에 따라 Coupon_Stock 테이블을 삭제하여 스키마를 단순화했습니다.

API 응답 방식 변경: 비동기 처리 모델을 도입함에 따라, 사용자에게 즉각적인 피드백을 주기 위해 기존의 쿠폰 정보 응답 대신 HTTP 202 Accepted 상태 코드를 반환하도록 변경했습니다. 
이는 "요청이 정상적으로 접수되었다"는 의미를 명확하게 전달하여 사용자 경험을 개선합니다.