# 📦 E-Commerce 주문 서비스 설계 문서

## 목차
1. [개요](#-개요)
2. [요구사항 분석 문서](#-요구사항-분석-문서)
   1. [기본 요구사항 목록](#️-기본-요구사항-목록)
   2. [포인트 충전 / 조회 API](#1️⃣-포인트-충전--조회-api)
   3. [상품 조회 API](#2️⃣-상품-조회-api)
   4. [주문 결제 API](#3️⃣-주문--결제-api)
   5. [선착순 쿠폰 기능 API](#4️⃣-선착순-쿠폰-기능)
   6. [인기 판매 상품 조회 API](#5️⃣-인기-판매-상품-조회-api)
3. [시퀀스 다이어그램](#-핵심-시퀀스-다이어그램)
4. [ERD](#-erd)

## ✅ 개요

향해플러스 과제 기반으로 설계된 E-Commerce 주문 서비스입니다. **요구사항 분석**, **시퀀스 다이어그램**, **ERD**를 정리했습니다.

---

## ✅ 요구사항 분석 문서

### ✳️ 기본 요구사항 목록

1. 포인트 충전 / 조회 API
2. 상품 조회 API
3. 주문 / 결제 API
4. 선착순 쿠폰 API
5. 인기 판매 상품 조회 API

### 1️⃣ 포인트 충전 / 조회 API

#### #️⃣ 포인트 조회

▶️ 기능적 요구사항

- 사용자를 식별하여 잔액을 조회한다.
- 잔액이 없으면 0으로 출력한다.

▶️ 잔액 조회 로직

1. 사용자 아이디 유효성 검사
2. 사용자 포인트 조회
3. 사용자 정보 반환(사용자 id, point)


#### #️⃣ 포인트 충전

▶️ 기능적 요구사항

- 충전 금액이 1,000원 이하, 1,000,000원 이상이면 실패 처리한다.
- 잔액을 충전하고 충전 이력을 남기고, 잔액을 반환한다.

▶️ 비기능적 요구사항

- 충전 시 동시성 제어가 되어야 한다.

▶️ 잔액 충전 로직

1. 사용자 아이디 유효성 검사
2. 포인트가 유효한 범위 내에 있는 지 확인(1,000 ~ 1,000,000)
3. 포인트 충전 + PointHistory 저장(id, pointId, userId, 충전 금액, 충전 일시, 충전 타입 (충전/차감/환불))
4. 잔액 포인트 조회

---

### 2️⃣ 상품 조회 API

▶️ 기능적 요구사항

- 상품 ID, 상품명, 가격 등의 기본 정보를 조회한다.
- 재고 정보를 함께 제공한다.
- 재고가 0이면 판매 불가로 표시한다.

▶️ 비기능적 요구사항

- 재고 데이터는 동시성 이슈 없이 정확해야 한다.

▶️ 상품 조회 로직

1. 상품의 id 유효성 검사를 한다.
2. 상품의 정보(id, 이름, 카테고리, 이미지 URL, 상품 설명)와 해당 상품 디테일(옵션, 수량)을 조회하고 반한한다.

---

### 3️⃣ 주문 / 결제 API

#### #️⃣ 주문

▶️ 기능적 요구사항

- 상품 ID 및 수량으로 주문 요청을 받는다.
- 존재하지 않거나 재고가 부족한 상품은 오류 반환
- 상품별 금액을 계산하여 총액 산정
- 유효한 쿠폰 사용 시 할인 적용 (총액보다 클 경우 0으로 처리)
- 주문 성공 시 주문 정보, 수량, 주문 상태 저장

▶️ 주문 로직

1. 유저 id, 상품 id, 상품 옵션, 수량, 쿠폰 사용여부, 쿠폰을 입력받아 유효성 검사를 진행한다.
2. 상품의 재고를 확인한다.
3. 쿠폰를 사용하여 주문할 금액을 계산한다.(총액보다 클 경우 주문 금액을 0으로 처리)
4. 주문 성공 시 주문 정보를 저장한다.(주문 상태 PENDING)
5. 결제 취소 시 주문의 상태를 바꿔야 한다.(주문 취소)

**주문은 성공했지만 결제는 실패한 상태 주의**

#### #️⃣ 결제

▶️ 기능적 요구사항

- 사용자 포인트(잔액)를 조회하여 주문 금액보다 적으면 오류
- 잔액에서 주문 금액 차감 후 결제 이력 저장
- 실패 시 주문 상태 변경

▶️ 비기능적 요구사항

- 주문 + 결제 트랜잭션이 atomic하게 처리되어야 함
- 잔액, 재고에 대한 동시성 제어
- 결제 성공 시 외부 데이터 플랫폼으로 주문 정보 전송 (비동기)

▶️ 결제 로직

1. 주문 번호를 받아 유효성 검사를 진행한다.
2. 주문 금액을 확인하고 사용자의 포인트를 조회한다.
3. 사용자 포인트를 차감한다.
4. 결제 data 생성(id, orderId, userId, paymentAmount, 결제 방법)
5. 주문 상태를 성공으로 변경한다.
6. 결제 정보를 외부 데이터 플랫폼에 전송한다.

---

### 4️⃣ 선착순 쿠폰 기능

▶️ 기능적 요구사항

- 쿠폰 발급 및 보유 쿠폰 목록을 조회할 수 있다.
- 쿠폰 정보: 유효기간, 할인 방식(정액/정률), 금액, 사용 여부
- 쿠폰 발급 조건:
  - 사용자에게 발급
  - 재고가 1 이상이어야 함
  - 만료일이 오늘 이후여야 함
  - 중복 발급 불가

- 쿠폰 목록 출력: 쿠폰 ID, 만료일, 할인 정보, 사용 여부 포함

▶️ 비기능적 요구사항

- 발급 시 동시성 제어가 필요하며 재고가 0이 되면 막아야 한다.

▶️ 선착순 쿠폰기능 로직

1. 선착순 쿠폰이 유효한지와 쿠폰 재고가 있는지 확인한다.(실시간)
2. UserCoupon생성(id, couponId, userId, 사용/미사용여부, 유효기간)

---

### 5️⃣ 인기 판매 상품 조회 API

▶️ 기능적 요구사항

- 최근 3일간 가장 많이 팔린 상위 5개 상품을 반환
- 일별 상품 판매량 테이블 기반 조회 (주문 테이블 직접 조회하지 않음)

▶️ 비기능적 요구사항

- 배치/스케줄러를 통해 30분마다 통계 데이터를 갱신하여 DB or Cache 저장

▶️ 인기 판매 상품 조회 로직

1. 배치 프로세스를 만들어(약 30분) 일정 시간마다 최근 3일간 많이 팔린 상위 5개 상품을 조회한다.(상품 id 단위로 옵션 수량 합산 집계)
2. 조회한 5개의 상품을 productRank 테이블에 저장한다.
3. 조회할 때마다 productRank 반환한다.

---

### ✳️ 추가 기능 (계획 혹은 선택 구현 항목)

▶️ 기능적 요구사항

- 로그인
- 회원가입
- 포인트가 10,000원 이상 있을 시 환불 처리
- 포인트 내역 조회
- 주문 내역 조회
- 상품 등록
- 상품 정보 수정
- 주문 취소

▶️ 비기능적 요구사항

- 사용자 인증 및 보안 처리

---

## ✅ 시퀀스 다이어그램 대상 선정 기준

**핵심 도메인 흐름 (데이터 변경 & 동시성 이슈가 존재)** 을 중심으로 선정했습니다.

**우선순위:**
1. **주문 + 결제 흐름 (포인트 차감 + 재고 차감 + 쿠폰 적용)**
2. **선착순 쿠폰 발급 흐름 (동시성)**
3. **상위 인기 상품 통계 배치 처리 (스케줄 기반)**

---

## ✅ 핵심 시퀀스 다이어그램

### 1. 주문 & 결제 시퀀스 다이어그램

<img width="3840" height="2867" alt="Image" src="https://github.com/user-attachments/assets/8f6cb20c-a91a-4143-b9c7-4b26b47e400e" />

### 2. 쿠폰 사용 다이어그램

<img width="3840" height="2867" alt="Image" src="https://github.com/user-attachments/assets/2c8208ba-2cb9-4d40-a84d-346d10bed544" />

### 3. 인기 상품 다이어그램

<img width="3840" height="1485" alt="Image" src="https://github.com/user-attachments/assets/428fa5a6-a1a7-43bf-b805-e4d508623e52" />


## ✅ ERD

<img width="3226" height="3839" alt="Image" src="https://github.com/user-attachments/assets/5a5ac922-64ba-4e58-98ab-ed71845b1f53" />

### 테이블 설명
| 테이블명         | 책임 설명 |
|------------------|-----------|
| `user`           | 사용자 정보를 저장 |
| `point`          | 사용자별 현재 보유 포인트(잔액) 정보를 관리 |
| `point_history`  | 포인트 충전, 차감, 환불 등의 모든 포인트 변화 이력을 기록 |
| `product`        | 상품의 기본 정보(이름, 카테고리, 가격 등)를 관리 |
| `product_option` | 상품에 대한 세부 옵션(색상, 사이즈 등)과 재고를 관리 |
| `order`          | 사용자의 주문 전체를 대표하는 정보와 상태(PENDING, COMPLETED 등)를 저장 |
| `order_item`     | 주문에 포함된 각 상품 옵션의 수량, 금액 등 세부 정보를 관리 |
| `payment`        | 주문에 대한 결제 정보 및 결제 상태를 관리 (성공/실패/환불 등) |
| `coupon`         | 발급 가능한 쿠폰 정보(할인 방식, 금액, 유효기간 등)를 정의 |
| `user_coupon`    | 사용자에게 발급된 쿠폰 정보(사용 여부, 만료일 등)를 관리 |
| `product_rank`    | 최근 인기 판매 상품의 순위를 저장 (배치로 집계된 통계 데이터) |
| `order_history`  | 주문 상태 변경 내역을 기록 (ex. PENDING → COMPLETED), 변경자 및 사유 포함 |